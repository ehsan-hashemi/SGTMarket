<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#d90429" />
  <title>SGT Market — مبدل استیکر (برنامک ایتا)</title>
  <link rel="icon" href="/icon.png" type="image/png" />

  <!-- فونت فارسی سبک و خوانا -->
  <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazir-font@v30.1.0/dist/font-face.css" rel="stylesheet">

  <!-- SDK جاوااسکریپت برنامک‌های ایتا (رسمی) -->
  <script src="https://developer.eitaa.com/eitaa-web-app.js" defer></script>

  <style>
    :root{
      --red1:#ef233c;--red2:#d90429;--red3:#9b001c;
      --text:#0f172a;--muted:#6b7280;--bg:#f7f8fa;--surface:#ffffff;--border:#e5e7eb;
      --radius:16px;--shadow:0 8px 20px rgba(16,24,40,0.06);--accent:#ef233c;
      --safe-top:env(safe-area-inset-top);--safe-bottom:env(safe-area-inset-bottom);
      --vh:100vh;
    }
    @media (prefers-color-scheme: dark){
      :root{--text:#f8fafc;--muted:#cbd5e1;--bg:#0b1020;--surface:#0f172a;--border:#1f2937;--shadow:none}
    }
    *{box-sizing:border-box;margin:0;padding:0;font-family:"Vazir",system-ui,-apple-system,Segoe UI,Roboto,sans-serif;-webkit-tap-highlight-color:transparent}
    html,body{height:100%}
    body{background:var(--bg);color:var(--text);line-height:1.65}

    .appbar{
      position:sticky;top:0;z-index:20;display:flex;align-items:center;justify-content:center;gap:10px;
      padding:calc(10px + var(--safe-top)) 12px 10px;
      background:linear-gradient(90deg,var(--red2),var(--red3));color:#fff;
      box-shadow:0 8px 18px rgba(217,4,41,0.25)
    }
    .brand{display:flex;align-items:center;gap:10px;color:#fff;text-decoration:none}
    .brand img{width:34px;height:34px;border-radius:12px;box-shadow:0 0 0 2px rgba(255,255,255,0.18)}
    .brand .title{font-weight:900;letter-spacing:-0.2px}
    .brand .subtitle{font-size:0.9rem;color:rgba(255,255,255,0.85)}

    .container{max-width:960px;margin:12px auto;padding:0 12px}
    .card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}

    .grid{display:grid;gap:12px;grid-template-columns:1fr}
    @media (min-width:940px){.grid{grid-template-columns:1.05fr 0.95fr}}

    .section{padding:12px}

    .zone{
      border:2px dashed rgba(0,0,0,0.22);border-radius:calc(var(--radius) - 6px);padding:16px;min-height:150px;
      background:linear-gradient(180deg,#fafafa,#f9fafb);
      display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px;text-align:center;cursor:pointer;
      transition:border-color .15s ease,background .15s ease
    }
    .zone:hover,.zone.hover{border-color:var(--red1);background:rgba(239,35,60,0.06)}
    .zone .big{
      font-weight:900;letter-spacing:-0.2px;font-size:1.02rem;background:linear-gradient(45deg,var(--red1),var(--red2));
      -webkit-background-clip:text;background-clip:text;color:transparent
    }
    .zone .hint{color:var(--muted);font-size:0.9rem}

    .preview{display:grid;gap:10px;padding:12px;border-top:1px dashed var(--border)}
    @media (min-width:940px){.preview{border-top:none;border-right:1px dashed var(--border)}}

    .img-wrap{
      position:relative;width:100%;aspect-ratio:4/3;border-radius:14px;overflow:hidden;background:#eef1f5;display:grid;place-items:center;border:1px solid var(--border)
    }
    .img-wrap img{max-width:100%;max-height:100%;object-fit:contain}
    .placeholder{position:absolute;color:#9aa3af;text-align:center}

    .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .btn{
      appearance:none;border:1px solid transparent;border-radius:12px;padding:12px 16px;min-height:48px;font-weight:800;cursor:pointer;
      transition:transform .12s ease,box-shadow .12s ease;box-shadow:var(--shadow)
    }
    .btn.secondary{background:#fff;border:1px solid var(--border);color:#0f172a}
    .btn:hover{transform:translateY(-1px)}.btn:active{transform:translateY(0) scale(0.99)}
    .btn:disabled{opacity:.6;cursor:not-allowed}

    .meta{display:grid;gap:6px;grid-template-columns:repeat(2,1fr)}
    @media(min-width:480px){.meta{grid-template-columns:repeat(4,1fr)}}
    .chip{background:rgba(239,35,60,0.08);border:1px solid rgba(239,35,60,0.35);color:#7f1d1d;border-radius:999px;padding:6px 10px;font-size:0.88rem;text-align:center}

    .row{display:flex;align-items:center;justify-content:space-between;gap:8px;margin:8px 0}
    .stat{font-size:0.9rem;color:var(--muted)} .value{font-weight:900;color:var(--text)}

    details{background:#fafafa;border:1px solid var(--border);border-radius:12px;padding:10px}
    summary{cursor:pointer;font-weight:900}
    .slider{width:160px}

    input[type="number"], select{width:140px;padding:10px;border-radius:10px;border:1px solid var(--border);background:#fff;color:#0f172a}
    .switch{display:flex;align-items:center;gap:8px}

    .progress{height:6px;background:#e7ecf2;border-radius:999px;overflow:hidden}
    .bar{width:0%;height:100%;background:linear-gradient(90deg,var(--red1),var(--red2));transition:width .25s ease}

    .alert{border:1px dashed var(--border);border-radius:12px;padding:10px;font-size:0.9rem;background:#fff;color:#0f172a;display:none}
    .alert.ok{border-color:rgba(46,204,113,0.5);background:#f0fdf4;color:#065f46}
    .alert.warn{border-color:rgba(255,183,3,0.45);background:#fffbeb;color:#92400e}
    .alert.err{border-color:rgba(255,77,79,0.5);background:#fef2f2;color:#991b1b}

    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);border:0}
    :focus-visible{outline:3px solid var(--accent);outline-offset:2px;border-radius:10px}

    footer{margin-top:10px;color:var(--muted);font-size:0.9rem;text-align:center;padding-bottom:calc(10px + var(--safe-bottom))}
  </style>
</head>
<body>

  <header class="appbar">
    <a class="brand" href="#">
      <img src="/icon.png" alt="SGT Market" />
      <div>
        <div class="title">SGT Market</div>
        <div class="subtitle">مبدل استیکر</div>
      </div>
    </a>
  </header>

  <div class="container">
    <div class="card">
      <div class="grid">
        <section class="section">
          <div id="dropZone" class="zone" tabindex="0" role="button" aria-label="فایل را بکشید و رها کنید یا برای انتخاب کلیک کنید">
            <div class="big">بکش و رها کن یا کلیک کن</div>
            <div class="hint">PNG, JPG, GIF, SVG و …</div>
            <input id="fileInput" class="sr-only" type="file" accept="image/*" />
          </div>

          <div style="height:10px"></div>

          <details>
            <summary>تنظیمات پیشرفته</summary>
            <div class="row" style="margin-top:6px">
              <div class="stat">کیفیت WebP</div>
              <input id="quality" class="slider" type="range" min="60" max="100" value="92" />
              <div><span id="qVal" class="value">92</span></div>
            </div>
            <div class="row">
              <div class="stat">فرمت خروجی</div>
              <select id="outFormat">
                <option value="webp" selected>WebP</option>
                <option value="png">PNG</option>
              </select>
            </div>
            <div class="row">
              <div class="stat">پیش‌تنظیم اندازه</div>
              <select id="presetSize">
                <option value="0" selected>بدون تغییر</option>
                <option value="512">512×512 (مناسب استیکر)</option>
                <option value="320">320×320</option>
              </select>
            </div>
            <div class="row">
              <label class="switch">
                <input id="squareFit" type="checkbox" />
                <span class="stat">خروجی مربعی و مرکزچین</span>
              </label>
            </div>
            <div class="row">
              <div class="stat">حداکثر عرض (پیکسل)</div>
              <input id="maxWidth" type="number" inputmode="numeric" min="0" placeholder="بدون تغییر">
            </div>
            <div class="row">
              <div class="stat">پس‌زمینه شفافیت</div>
              <input id="bgColor" type="color" value="#000000" />
            </div>
          </details>

          <div style="height:10px"></div>
          <div class="progress" aria-hidden="true"><div id="bar" class="bar"></div></div>
          <div id="note" class="alert warn" style="margin-top:10px"></div>
        </section>

        <aside class="preview">
          <div class="img-wrap">
            <img id="preview" alt="پیش‌نمایش" />
            <div id="placeholder" class="placeholder">هنوز عکسی انتخاب نشده است.</div>
          </div>

          <div class="meta">
            <div class="chip">حجم ورودی: <span id="inSize">۰</span></div>
            <div class="chip">حجم خروجی: <span id="outSize">۰</span></div>
            <div class="chip">ابعاد: <span id="dims">—</span></div>
            <div class="chip">صرفه‌جویی: <span id="saved">—</span></div>
          </div>

          <div class="row">
            <div class="controls">
              <button id="saveBtn" class="btn secondary" disabled>دانلود</button>
              <button id="shareBtn" class="btn secondary" disabled>اشتراک‌گذاری</button>
            </div>
          </div>
        </aside>
      </div>
    </div>

    <footer>© 2025 SGT Market</footer>
  </div>

  <script type="module">
    /* عناصر */
    const fileInput = document.getElementById('fileInput');
    const dropZone = document.getElementById('dropZone');

    const preview = document.getElementById('preview');
    const placeholder = document.getElementById('placeholder');
    const inSize = document.getElementById('inSize');
    const outSize = document.getElementById('outSize');
    const dims = document.getElementById('dims');
    const saved = document.getElementById('saved');
    const bar = document.getElementById('bar');

    const saveBtn = document.getElementById('saveBtn');
    const shareBtn = document.getElementById('shareBtn');

    const note = document.getElementById('note');
    const quality = document.getElementById('quality');
    const qVal = document.getElementById('qVal');
    const maxWidth = document.getElementById('maxWidth');
    const bgColor = document.getElementById('bgColor');
    const outFormat = document.getElementById('outFormat');
    const presetSize = document.getElementById('presetSize');
    const squareFit = document.getElementById('squareFit');

    /* وضعیت */
    let originalFile = null;
    let outputBlob = null;
    let outputURL = null;     // blob: preview
    let outputHttps = null;   // https: برای دانلود/اشتراک
    let outputName = null;
    let imgWidth = 0, imgHeight = 0;

    /* ابزار */
    const fmtBytes = (b) => {
      if (!b && b !== 0) return '—';
      const u = ['B','KB','MB','GB'];
      let i = 0, v = b;
      while (v >= 1024 && i < u.length-1){ v/=1024; i++; }
      return (Math.round(v*10)/10)+' '+u[i];
    };
    const setBar = (p) => { bar.style.width = Math.max(0, Math.min(100, p)) + '%'; };
    const showNote = (msg, type='warn') => { note.textContent = msg; note.className = 'alert ' + type; note.style.display = 'block'; };
    const hideNote = () => { note.style.display = 'none'; };

    /* SDK ایتا */
    const EA = (window.Eitaa && window.Eitaa.WebApp) ? window.Eitaa.WebApp : null;

    function applyEitaaEnvironment(){
      if (!EA) return;
      try{
        EA.ready?.();
        EA.requestFullscreen?.();

        EA.setHeaderColor?.('bg_color');
        EA.setBackgroundColor?.('bg_color');
        EA.setBottomBarColor?.('bottom_bar_bg_color');

        const tp = EA.themeParams || {};
        tp.bg_color && document.documentElement.style.setProperty('--bg', tp.bg_color);
        tp.text_color && document.documentElement.style.setProperty('--text', tp.text_color);
        tp.hint_color && document.documentElement.style.setProperty('--muted', tp.hint_color);

        const ins = EA.safeAreaInset || {};
        (ins.top != null) && document.documentElement.style.setProperty('--safe-top', ins.top + 'px');
        (ins.bottom != null) && document.documentElement.style.setProperty('--safe-bottom', ins.bottom + 'px');

        const vh = EA.viewportStableHeight || EA.viewportHeight || window.innerHeight;
        document.documentElement.style.setProperty('--vh', vh + 'px');

        EA.onEvent?.('viewportChanged', () => {
          const vh2 = EA.viewportStableHeight || EA.viewportHeight || window.innerHeight;
          document.documentElement.style.setProperty('--vh', vh2 + 'px');
        });

        // دکمه‌های پایین برنامک برای تعامل کاربر
        EA.MainButton?.setParams?.({ text:'دانلود', is_active:true, is_visible:true });
        EA.SecondaryButton?.setParams?.({ text:'اشتراک‌گذاری', is_active:true, is_visible:true, position:'right' });

        EA.onEvent?.('mainButtonClicked', () => saveBtn.click());
        EA.onEvent?.('secondaryButtonClicked', () => shareBtn.click());

        EA.BackButton?.show?.();
        EA.onEvent?.('backButtonClicked', () => EA.close?.());
      } catch(e){}
    }

    function resetState(){
      originalFile = null;
      if (outputURL) URL.revokeObjectURL(outputURL);
      outputURL = null; outputBlob = null; outputHttps = null; outputName = null;
      preview.removeAttribute('src'); placeholder.style.display = 'block';
      inSize.textContent = '۰'; outSize.textContent = '۰'; dims.textContent = '—'; saved.textContent = '—';
      saveBtn.disabled = true; shareBtn.disabled = true;
      setBar(0); hideNote();
    }
    resetState();

    qVal.textContent = quality.value;
    quality.addEventListener('input', () => qVal.textContent = quality.value);

    // فول‌اسکرین در اولین تعامل (کلاینت‌های سخت‌گیر)
    function ensureFullscreenOnGesture(){
      try { EA?.requestFullscreen?.(); } catch(e){}
      document.removeEventListener('pointerdown', ensureFullscreenOnGesture, { once:true });
    }
    document.addEventListener('pointerdown', ensureFullscreenOnGesture, { once:true });

    dropZone.addEventListener('click', () => fileInput.click());
    dropZone.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); fileInput.click(); }
    });
    dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('hover'); });
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('hover'));
    dropZone.addEventListener('drop', (e) => {
      e.preventDefault(); dropZone.classList.remove('hover');
      const file = e.dataTransfer.files && e.dataTransfer.files[0];
      if (file) handleFile(file);
    });
    fileInput.addEventListener('change', (e) => {
      const file = e.target.files && e.target.files[0];
      if (file) handleFile(file);
    });

    // بارگذار سازگار: createImageBitmap → Image(blob URL) → FileReader(data URL)
    async function loadImageFromFile(file){
      // جلوگیری از فرمت‌های دشوار (HEIC/HEIF) که معمولاً پشتیبانی نمی‌شوند
      const name = (file.name || '').toLowerCase();
      if (/\.(heic|heif|raw|cr2|nef|arw)$/.test(name)) {
        throw new Error('این فرمت در مرورگر/وب‌ویو پشتیبانی نمی‌شود.');
      }

      if (window.createImageBitmap){
        try {
          const bitmap = await createImageBitmap(file);
          const c = document.createElement('canvas');
          c.width = bitmap.width; c.height = bitmap.height;
          c.getContext('2d').drawImage(bitmap, 0, 0);
          bitmap.close?.();
          const img = new Image();
          img.src = c.toDataURL('image/png');
          await new Promise((resolve, reject)=>{ img.onload = resolve; img.onerror = ()=> reject(new Error('بارگذاری bitmap ناموفق')); });
          return img;
        } catch {}
      }
      try {
        const url = URL.createObjectURL(file);
        const img = new Image();
        const p = new Promise((res, rej) => {
          img.onload = () => { URL.revokeObjectURL(url); res(); };
          img.onerror = () => { URL.revokeObjectURL(url); rej(new Error('بارگذاری blob ناموفق')); };
        });
        img.src = url;
        await p;
        return img;
      } catch {}
      return await new Promise((resolve, reject) => {
        const fr = new FileReader();
        fr.onerror = () => reject(new Error('عدم توانایی در بارگذاری تصویر (فرمت یا داده نامعتبر)'));
        fr.onload = () => {
          const img = new Image();
          img.onload = () => resolve(img);
          img.onerror = () => reject(new Error('عدم توانایی در بارگذاری تصویر (فرمت یا داده نامعتبر)'));
          img.src = fr.result;
        };
        fr.readAsDataURL(file);
      });
    }

    async function handleFile(file){
      resetState();
      originalFile = file;
      inSize.textContent = fmtBytes(file.size);
      const base = (file.name || 'image').replace(/\.[^.]+$/, '');
      const desiredExt = outFormat.value === 'png' ? '.png' : '.webp';
      outputName = base + desiredExt;

      try{
        setBar(10);

        const img = await loadImageFromFile(file);

        imgWidth = img.naturalWidth || img.width;
        imgHeight = img.naturalHeight || img.height;
        if (!imgWidth || !imgHeight) throw new Error('ابعاد تصویر قابل تشخیص نیست');

        const preset = parseInt(presetSize.value || '0', 10);
        const maxWNum = parseInt(maxWidth.value || '0', 10);

        let targetW = imgWidth, targetH = imgHeight;

        if (preset > 0 && squareFit.checked){
          targetW = targetH = preset;
        } else {
          if (maxWNum > 0 && imgWidth > maxWNum){
            const scale = maxWNum / imgWidth;
            targetW = Math.max(1, Math.round(imgWidth * scale));
            targetH = Math.max(1, Math.round(imgHeight * scale));
          }
          if (preset > 0 && !squareFit.checked){
            const scale = Math.min(1, preset / Math.max(targetW, targetH));
            targetW = Math.max(1, Math.round(targetW * scale));
            targetH = Math.max(1, Math.round(targetH * scale));
          }
        }

        setBar(35);

        let canvasW = targetW, canvasH = targetH;
        if (preset > 0 && squareFit.checked){
          canvasW = canvasH = preset;
        }

        const canvas = document.createElement('canvas');
        canvas.width = canvasW; canvas.height = canvasH;
        const ctx = canvas.getContext('2d', { alpha: true });
        ctx.imageSmoothingEnabled = true; ctx.imageSmoothingQuality = 'high';

        if (bgColor.value && bgColor.value !== '#000000') {
          ctx.fillStyle = bgColor.value;
          ctx.fillRect(0, 0, canvasW, canvasH);
        } else {
          ctx.clearRect(0, 0, canvasW, canvasH);
        }

        let drawX = 0, drawY = 0, drawW = targetW, drawH = targetH;
        if (preset > 0 && squareFit.checked){
          const scale = Math.min(canvasW / imgWidth, canvasH / imgHeight);
          drawW = Math.max(1, Math.round(imgWidth * scale));
          drawH = Math.max(1, Math.round(imgHeight * scale));
          drawX = Math.floor((canvasW - drawW) / 2);
          drawY = Math.floor((canvasH - drawH) / 2);
        }

        ctx.drawImage(img, drawX, drawY, drawW, drawH);

        setBar(60);

        // خروجی
        const type = outFormat.value === 'png' ? 'image/png' : 'image/webp';
        const supportsWebP = (() => {
          try { const c = document.createElement('canvas'); return c.toDataURL('image/webp').startsWith('data:image/webp'); }
          catch { return false; }
        })();
        const finalType = (type === 'image/webp' && !supportsWebP) ? 'image/png' : type;

        const q = Math.max(0.6, Math.min(1, (parseInt(quality.value, 10) || 92) / 100));
        const blob = await new Promise((res, rej) => {
          if (finalType === 'image/png'){
            canvas.toBlob(b => b ? res(b) : rej(new Error('تبدیل ناموفق')), 'image/png');
          } else {
            canvas.toBlob(b => b ? res(b) : rej(new Error('تبدیل ناموفق')), 'image/webp', q);
          }
        });

        if (!blob || !blob.size) throw new Error('خروجی تصویر خالی است.');

        outputBlob = blob;
        if (outputURL) URL.revokeObjectURL(outputURL);
        outputURL = URL.createObjectURL(blob);

        preview.src = outputURL;
        preview.onload = () => { placeholder.style.display = 'none'; };

        dims.textContent = canvasW + '×' + canvasH;
        outSize.textContent = fmtBytes(blob.size);
        const gain = originalFile.size > 0 ? Math.max(0, 100 - Math.round((blob.size / originalFile.size) * 100)) : 0;
        saved.textContent = gain + '٪';

        setBar(100);
        saveBtn.disabled = false; shareBtn.disabled = false;
      } catch (err) {
        showNote('خطا در تبدیل تصویر: ' + err.message, 'err');
        setBar(0);
      }
    }

    // آپلود Blob به HTTPS برای دانلود و اشتراک‌گذاری
    // این تابع باید روی سرور خودت پیاده‌سازی شود (endpoint نمونه: /upload-image)
    async function uploadBlobToHttps(blob, filename, mime){
      // سرور باید برگرداند: { url: "https://your-cdn/..." }
      const form = new FormData();
      form.append('file', blob, filename);
      form.append('mime', mime);
      const res = await fetch('/upload-image', { method:'POST', body:form });
      if (!res.ok) throw new Error('آپلود به سرور ناموفق بود.');
      const data = await res.json();
      if (!data || typeof data.url !== 'string' || !/^https:\/\//.test(data.url)) {
        throw new Error('آدرس HTTPS معتبر از سرور دریافت نشد.');
      }
      return data.url;
    }

    // دانلود با SDK ایتا (نیاز به HTTPS)
    saveBtn.addEventListener('click', async () => {
      if (!outputBlob) { showNote('ابتدا تصویر را تبدیل کنید.', 'warn'); return; }
      try {
        // اگر قبلاً آپلود شده، استفاده کن؛ در غیر این صورت آپلود کن
        if (!outputHttps) {
          const mime = (outFormat.value === 'png') ? 'image/png' : 'image/webp';
          outputHttps = await uploadBlobToHttps(outputBlob, outputName || (outFormat.value==='png'?'image.png':'image.webp'), mime);
        }

        if (EA && EA.isVersionAtLeast?.('1.4')) {
          EA.MainButton?.showProgress?.(true);
          EA.downloadFile({ url: outputHttps, file_name: outputName || 'download' });
          EA.MainButton?.hideProgress?.();
          EA.HapticFeedback?.notificationOccurred?.('success');
          showNote('درخواست دانلود ارسال شد.', 'ok');
        } else {
          // fallback: بازکردن لینک در مرورگر (برنامک نمی‌بندد)
          EA?.openLink?.(outputHttps, { try_browser:true });
          showNote('لینک دانلود در مرورگر باز شد.', 'ok');
        }
      } catch (err) {
        EA?.HapticFeedback?.notificationOccurred?.('error');
        showNote('خطا در دانلود: ' + err.message, 'err');
      }
    });

    // اشتراک‌گذاری با باز کردن لینک در ایتا/مرورگر
    shareBtn.addEventListener('click', async () => {
      if (!outputBlob) { showNote('ابتدا تصویر را تبدیل کنید.', 'warn'); return; }
      try {
        if (!outputHttps) {
          const mime = (outFormat.value === 'png') ? 'image/png' : 'image/webp';
          outputHttps = await uploadBlobToHttps(outputBlob, outputName || (outFormat.value==='png'?'image.png':'image.webp'), mime);
        }

        // اگر لینک داخلی ایتاست، از openEitaaLink استفاده کن؛ اینجا فرض بیرونی است:
        EA?.openLink?.(outputHttps, { try_instant_view:true, try_browser:true });
        EA?.HapticFeedback?.selectionChanged?.();
        showNote('لینک اشتراک‌گذاری باز شد.', 'ok');
      } catch (err) {
        EA?.HapticFeedback?.notificationOccurred?.('error');
        showNote('خطا در اشتراک‌گذاری: ' + err.message, 'err');
      }
    });

    // آماده‌سازی
    window.addEventListener('DOMContentLoaded', applyEitaaEnvironment);
  </script>
</body>
</html>